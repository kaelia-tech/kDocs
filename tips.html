<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Tips | KDK</title>
    <meta name="generator" content="VuePress 1.8.0">
    <link rel="icon" href="https://s3.eu-central-1.amazonaws.com/kalisioscope/kdk/kdk-icon-64x64.png">
    <link rel="manifest" href="/kdk/manifest.json">
    <meta name="description" content="The Kalisio Development Kit">
    
    <link rel="preload" href="/kdk/assets/css/0.styles.d338d316.css" as="style"><link rel="preload" href="/kdk/assets/js/app.a4477def.js" as="script"><link rel="preload" href="/kdk/assets/js/3.4838e27f.js" as="script"><link rel="preload" href="/kdk/assets/js/43.fb2709af.js" as="script"><link rel="preload" href="/kdk/assets/js/9.9b9d823c.js" as="script"><link rel="prefetch" href="/kdk/assets/js/10.422a18ba.js"><link rel="prefetch" href="/kdk/assets/js/11.6146572c.js"><link rel="prefetch" href="/kdk/assets/js/12.ff944384.js"><link rel="prefetch" href="/kdk/assets/js/13.8361596c.js"><link rel="prefetch" href="/kdk/assets/js/14.e12a5d2f.js"><link rel="prefetch" href="/kdk/assets/js/15.5658cf4a.js"><link rel="prefetch" href="/kdk/assets/js/16.d8ccdbd2.js"><link rel="prefetch" href="/kdk/assets/js/17.b5b4ded0.js"><link rel="prefetch" href="/kdk/assets/js/18.c2264a79.js"><link rel="prefetch" href="/kdk/assets/js/19.fa8fa9b6.js"><link rel="prefetch" href="/kdk/assets/js/2.51fc9f3f.js"><link rel="prefetch" href="/kdk/assets/js/20.4a84894e.js"><link rel="prefetch" href="/kdk/assets/js/21.ec5cbeac.js"><link rel="prefetch" href="/kdk/assets/js/22.846467d8.js"><link rel="prefetch" href="/kdk/assets/js/23.f81eb682.js"><link rel="prefetch" href="/kdk/assets/js/24.824ae611.js"><link rel="prefetch" href="/kdk/assets/js/25.55fe4b6b.js"><link rel="prefetch" href="/kdk/assets/js/26.6aa473d4.js"><link rel="prefetch" href="/kdk/assets/js/27.4654bd50.js"><link rel="prefetch" href="/kdk/assets/js/28.99577333.js"><link rel="prefetch" href="/kdk/assets/js/29.165b487e.js"><link rel="prefetch" href="/kdk/assets/js/30.d0d27f7a.js"><link rel="prefetch" href="/kdk/assets/js/31.2ee15340.js"><link rel="prefetch" href="/kdk/assets/js/32.571e4ca9.js"><link rel="prefetch" href="/kdk/assets/js/33.61796975.js"><link rel="prefetch" href="/kdk/assets/js/34.97fee52f.js"><link rel="prefetch" href="/kdk/assets/js/35.96999543.js"><link rel="prefetch" href="/kdk/assets/js/36.e5771da0.js"><link rel="prefetch" href="/kdk/assets/js/37.343bdea5.js"><link rel="prefetch" href="/kdk/assets/js/38.1082baa0.js"><link rel="prefetch" href="/kdk/assets/js/39.d2ed77fe.js"><link rel="prefetch" href="/kdk/assets/js/4.73c0aebf.js"><link rel="prefetch" href="/kdk/assets/js/40.fe50807b.js"><link rel="prefetch" href="/kdk/assets/js/41.e70cba05.js"><link rel="prefetch" href="/kdk/assets/js/42.b1984d22.js"><link rel="prefetch" href="/kdk/assets/js/44.9873b3a3.js"><link rel="prefetch" href="/kdk/assets/js/45.3057494d.js"><link rel="prefetch" href="/kdk/assets/js/46.ed5fa649.js"><link rel="prefetch" href="/kdk/assets/js/47.ebb9677f.js"><link rel="prefetch" href="/kdk/assets/js/48.7245159d.js"><link rel="prefetch" href="/kdk/assets/js/49.24eed01f.js"><link rel="prefetch" href="/kdk/assets/js/5.66b85194.js"><link rel="prefetch" href="/kdk/assets/js/50.e4bc8a1e.js"><link rel="prefetch" href="/kdk/assets/js/51.916d8ef1.js"><link rel="prefetch" href="/kdk/assets/js/52.f1def92b.js"><link rel="prefetch" href="/kdk/assets/js/6.9993cfdb.js"><link rel="prefetch" href="/kdk/assets/js/7.0eeb36e7.js"><link rel="prefetch" href="/kdk/assets/js/8.e6c27f46.js">
    <link rel="stylesheet" href="/kdk/assets/css/0.styles.d338d316.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/kdk/" class="home-link router-link-active"><!----> <span class="site-name">KDK</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/kdk/about/" class="nav-link">
  About
</a></div><div class="nav-item"><a href="/kdk/guides/" class="nav-link">
  Guides
</a></div><div class="nav-item"><a href="/kdk/architecture/" class="nav-link">
  Architecture
</a></div><div class="nav-item"><a href="/kdk/api/" class="nav-link">
  API
</a></div><div class="nav-item"><a href="/kdk/tips.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Tips
</a></div><div class="nav-item"><a href="/kdk/tools/" class="nav-link">
  Tools
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/kdk/about/" class="nav-link">
  About
</a></div><div class="nav-item"><a href="/kdk/guides/" class="nav-link">
  Guides
</a></div><div class="nav-item"><a href="/kdk/architecture/" class="nav-link">
  Architecture
</a></div><div class="nav-item"><a href="/kdk/api/" class="nav-link">
  API
</a></div><div class="nav-item"><a href="/kdk/tips.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Tips
</a></div><div class="nav-item"><a href="/kdk/tools/" class="nav-link">
  Tools
</a></div> <!----></nav> <p align="center"><a href="https://kalisio.com"><img src="https://s3.eu-central-1.amazonaws.com/kalisioscope/kalisio/kalisio-logo-black-256x84.png"></a> <br> <!----></p> <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="tips"><a href="#tips" class="header-anchor">#</a> Tips</h1> <h2 id="generating-service-account-tokens"><a href="#generating-service-account-tokens" class="header-anchor">#</a> Generating service account tokens</h2> <p>If you'd like a third-party application to rely on the API of your application without authenticating using a user/password you can generate an access token with a fixed expiration date to be used as an API key.</p> <p>If your API needs a user ID to work as expected first register a user as usual. Then, using your application secret and a <a href="https://jwt.io/" target="_blank" rel="noopener noreferrer">JWT library<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, issue a JWT with a payload matching the configuration options of your application regarding audience (i.e. domain), issuer and the user ID if any, e.g.:</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;aud&quot;</span><span class="token operator">:</span> <span class="token string">&quot;kano.kargo.kalisio.xyz&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;iss&quot;</span><span class="token operator">:</span> <span class="token string">&quot;kalisio&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;exp&quot;</span><span class="token operator">:</span> <span class="token number">1552402010</span><span class="token punctuation">,</span>
  <span class="token property">&quot;userId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;5bc5b166beb4648d3cd79327&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="linking-errors"><a href="#linking-errors" class="header-anchor">#</a> Linking errors</h2> <p>Due to the modular approach of the KDK we need to <a href="https://medium.com/@alexishevia/the-magic-behind-npm-link-d94dcb3a81af" target="_blank" rel="noopener noreferrer">link<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> the modules and the applications according to the dependency tree when developing.</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>Due to some <a href="http://codetunnel.io/npm-5-changes-to-npm-link/" target="_blank" rel="noopener noreferrer">changes<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> in the way <code>npm</code> manages linked modules we prefer to use <a href="https://yarnpkg.com" target="_blank" rel="noopener noreferrer">Yarn<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> as a package manager.</p></div> <p>It appeared that when performing a new install, adding a new dependency, or launching two installs concurrently, some of these links often break raising different errors:</p> <ul><li><code>TypeError: Cannot read property 'eventMappings' of undefined</code></li> <li><code>TypeError: processNextTick is not a function</code></li> <li><code>Error: Cannot find module 'safer-buffer'</code></li> <li><code>An unexpected error occurred: &quot;ENOENT: no such file or directory, scandir 'xxx'</code></li> <li>...</li></ul> <p>As a workaround you will either need to:</p> <ul><li>clear the yarn cache <code>yarn cache clean</code> (or <code>yarn cache clean module</code> to be more specific)</li> <li>restore the broken links using commands like e.g. <code>yarn link @kalisio/kdk</code> in the broken applications</li> <li>reinstall all dependencies using <code>yarn install</code> in broken modules/applications, and then restore the links as above</li></ul> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>You might also clean all dependencies frist using <a href="http://www.nikola-breznjak.com/blog/javascript/nodejs/how-to-delete-node_modules-folder-on-windows-machine/" target="_blank" rel="noopener noreferrer"><code>rimraf node_modules</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>Errors are often visible when launching the app server but might come from an underlying module. For instance the <code>TypeError: Cannot read property 'eventMappings' of undefined</code> error often appears in modules, probably due to the fact incompatible versions of the same library (e.g. Feathers) are installed. So try first to reinstall and relink the modules before your app, and if you'd like to see if a module is fine running its tests is usually a good indicator: <code>yarn mocha</code>.</p></div> <h2 id="running-multiple-applications-side-by-side"><a href="#running-multiple-applications-side-by-side" class="header-anchor">#</a> Running multiple applications side-by-side</h2> <p>For instance, as Kano depends for some features on a running Weacast API you will need to run both on your local development environment. If your application also uses replication you will need to launch two instances in parallel. The problem is that by default all our apps uses the <code>8081</code> port for server and <code>8080</code> port for client in development mode, generating a port conflict. Similarly the Node.js debugger uses by default the <code>9229</code> port.</p> <p>You should run the first server by defining eg. <code>PORT=8082</code> (to avoid port conflict). If single-sign-on is expected to work, define also <code>APP_SECRET=same value as in second application configuration</code> as environment variables. Then execute the <code>yarn dev:replica</code> command (will setup the Node.js debugger to use the <code>9229</code> port to avoid port conflict). Last, you can launch the second server/client as usual.</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>You usually don't need the client application but only the API on the replica but if required you can launch another client similarly e.g. by setting <code>CLIENT_PORT=8083</code>.</p></div> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>If you need more than two side-by-side applications then use set <a href="https://nodejs.org/api/cli.html#cli_node_options_options" target="_blank" rel="noopener noreferrer">NODE_OPTIONS<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> environment variable before launching each one, e.g. <code>NODE_OPTIONS='--inspect-port=9230'</code>.</p></div> <h3 id="application-instances-synchronization"><a href="#application-instances-synchronization" class="header-anchor">#</a> Application instances synchronization</h3> <p>If your application is not fully stateless or requires real-time events to be dispatched to clients you will also need to synchronize them using <a href="https://github.com/feathersjs-ecosystem/feathers-sync" target="_blank" rel="noopener noreferrer">feathers-sync<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. We previously relied on the <a href="https://github.com/scttnlsn/mubsub" target="_blank" rel="noopener noreferrer">mubsub<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> adapter because as we already use MongoDB it did not require any additional service to be deployed.</p> <p>Unfortunately it has been <a href="https://github.com/feathersjs-ecosystem/feathers-sync/pull/135" target="_blank" rel="noopener noreferrer">deprecated<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. As a consequence we now rely on the <a href="https://redis.io/" target="_blank" rel="noopener noreferrer">Redis<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> adapter. For development you can easily run a Redis server using Docker:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>// Bind it to your prefered port
docker run -d --rm --name redis -p <span class="token number">6300</span>:6379 redis:5
</code></pre></div><p>You will need to play with the different options presented above to avoid port conflicts and define as well how your app connects to the Redis instance using the <code>REDIS_URL</code> environment variable like <code>redis://127.0.0.1:6300</code>. You can see the subscriber apps and exchanged messages by connecting to the Redis container:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>// Bind it to your prefered port
docker <span class="token builtin class-name">exec</span> -it redis <span class="token function">bash</span>
<span class="token operator">&gt;</span> redis-cli
// Number of subscribers
<span class="token operator">&gt;</span> PUBSUB NUMSUB feathers-sync
<span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">&quot;feathers-sync&quot;</span>
<span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">2</span>
// Monitor messages
<span class="token operator">&gt;</span> SUBSCRIBE feathers-sync
Reading messages<span class="token punctuation">..</span>.
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/kdk/assets/js/app.a4477def.js" defer></script><script src="/kdk/assets/js/3.4838e27f.js" defer></script><script src="/kdk/assets/js/43.fb2709af.js" defer></script><script src="/kdk/assets/js/9.9b9d823c.js" defer></script>
  </body>
</html>
