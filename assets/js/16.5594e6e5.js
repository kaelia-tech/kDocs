(window.webpackJsonp=window.webpackJsonp||[]).push([[16],{195:function(e,t,i){e.exports=i.p+"assets/img/cd-pipeline.79fa1089.svg"},211:function(e,t,i){"use strict";i.r(t);var s=[function(){var e=this.$createElement,t=this._self._c||e;return t("h1",{attrs:{id:"deploy-your-app"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#deploy-your-app","aria-hidden":"true"}},[this._v("#")]),this._v(" Deploy your app")])},function(){var e=this.$createElement,t=this._self._c||e;return t("h2",{attrs:{id:"deployment-pipeline"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#deployment-pipeline","aria-hidden":"true"}},[this._v("#")]),this._v(" Deployment pipeline")])},function(){var e=this.$createElement,t=this._self._c||e;return t("p",[t("img",{attrs:{src:i(195),alt:"Deployment pipeline"}})])},function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("ul",[i("li",[i("strong",[e._v("BUILD")]),e._v(": executes the "),i("em",[e._v("travis.build.sh")]),e._v(" script to create the Docker images")]),e._v(" "),i("li",[i("strong",[e._v("TEST")]),e._v(": executes the "),i("em",[e._v("travis.test.sh")]),e._v(" script to run backend and frontend tests")]),e._v(" "),i("li",[i("strong",[e._v("DEPLOY")]),e._v(": executes the "),i("em",[e._v("travis.deploy.sh")]),e._v(" script to deploy the web application on the target infrastructure")]),e._v(" "),i("li",[i("strong",[e._v("ANDROID")]),e._v(": executes the "),i("em",[e._v("travis.android.sh")]),e._v(" script to build the Android APK and deploy it to Google Play")]),e._v(" "),i("li",[i("strong",[e._v("IOS")]),e._v(": executes the "),i("em",[e._v("travis.ios.sh")]),e._v(" script to build the iOS IPA and deploy it to App Store Connect")])])},function(){var e=this.$createElement,t=this._self._c||e;return t("div",{staticClass:"tip custom-block"},[t("p",{staticClass:"custom-block-title"},[this._v("TIP")]),this._v(" "),t("p",[this._v("You can skip any of this stage by adding "),t("code",[this._v("[skip stage]")]),this._v(" to your commit message, e.g. "),t("code",[this._v("[skip android]")]),this._v(" to skip the Android build")])])},function(){var e=this.$createElement,t=this._self._c||e;return t("p",[this._v("CI/CD comes al well in three different flavors, as defined by the value of the "),t("code",[this._v("FLAVOR")]),this._v("/"),t("code",[this._v("NODE_APP_INSTANCE")]),this._v(" environment variables:")])},function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("ul",[i("li",[i("strong",[e._v("dev")]),e._v(": in order to deploy current development/alpha version, linked to the "),i("code",[e._v("master")]),e._v(" branch of your code")]),e._v(" "),i("li",[i("strong",[e._v("test")]),e._v(": in order to deploy current staging/beta version, linked to the "),i("code",[e._v("test")]),e._v(" branch of your code")]),e._v(" "),i("li",[i("strong",[e._v("prod")]),e._v(": in order to deploy current production version, linked to "),i("code",[e._v("tags")]),e._v(" on the "),i("code",[e._v("test")]),e._v(" branch of your code")])])},function(){var e=this.$createElement,t=this._self._c||e;return t("div",{staticClass:"tip custom-block"},[t("p",{staticClass:"custom-block-title"},[this._v("TIP")]),this._v(" "),t("p",[this._v("In the CI/CD process the "),t("code",[this._v("FLAVOR")]),this._v("/"),t("code",[this._v("NODE_APP_INSTANCE")]),this._v(" environment variable is automatically set based on the branch/tag you are pushing. During local development these variables are usually not defined.")])])},function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("ul",[i("li",[e._v("a root domain, defined by the value of the "),i("code",[e._v("DOMAIN")]),e._v(" environment variable like "),i("code",[e._v("kalisio.xyz")])]),e._v(" "),i("li",[e._v("a version number, defined by the value of the "),i("code",[e._v("VERSION")]),e._v(" environment variable like "),i("code",[e._v("1.3.0")]),e._v(" and automatically extracted from your "),i("em",[e._v("package.json")]),e._v(" file")]),e._v(" "),i("li",[e._v("a name, defined in the "),i("code",[e._v("APP")]),e._v(" environment variable like "),i("code",[e._v("kapp")])])])},function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("ul",[i("li",[i("strong",[e._v("dev")]),e._v(": "),i("code",[e._v("SUBDOMAIN=dev.$DOMAIN")]),e._v(", "),i("code",[e._v("VERSION_TAG=$VERSION-dev")])]),e._v(" "),i("li",[i("strong",[e._v("test")]),e._v(": "),i("code",[e._v("SUBDOMAIN=test.$DOMAIN")]),e._v(", "),i("code",[e._v("VERSION_TAG=$VERSION-test")])]),e._v(" "),i("li",[i("strong",[e._v("prod")]),e._v(": "),i("code",[e._v("SUBDOMAIN=$DOMAIN")]),e._v(", "),i("code",[e._v("VERSION_TAG=$VERSION")])])])},function(){var e=this.$createElement,t=this._self._c||e;return t("p",[this._v("The subdomain is usually used to build a fully-qualified domain name for the application based on its name, i.e. "),t("code",[this._v("$APP.$SUBDOMAIN")]),this._v(". The version tag defines the name of the created Docker images like "),t("code",[this._v("$APP:$VERSION_TAG")]),this._v(", based on the associated Docker file "),t("code",[this._v("dockerfile.$FLAVOR")]),this._v(".")])},function(){var e=this.$createElement,t=this._self._c||e;return t("p",[t("strong",[this._v("To be completed")])])},function(){var e=this.$createElement,t=this._self._c||e;return t("h2",{attrs:{id:"configure-ci-cd"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#configure-ci-cd","aria-hidden":"true"}},[this._v("#")]),this._v(" Configure CI/CD")])},function(){var e=this.$createElement,t=this._self._c||e;return t("p",[this._v("As an application often relies on third-party services its configuration must include secrets like API keys, passwords, etc. In this section we detail how we manage it in a secure way. Indeed, to set up the CI/CD pipeline, sensitive data are needed to access the required services (SSH, third-party, etc.) and "),t("strong",[this._v("should not be pushed under source control unless you use private repositories or encryption")]),this._v(".")])},function(){var e=this.$createElement,t=this._self._c||e;return t("h3",{attrs:{id:"secret-variables"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#secret-variables","aria-hidden":"true"}},[this._v("#")]),this._v(" Secret variables")])},function(){var e=this.$createElement,t=this._self._c||e;return t("div",{staticClass:"warning custom-block"},[t("p",{staticClass:"custom-block-title"},[this._v("WARNING")]),this._v(" "),t("p",[this._v("If you'd like to set a value holding multilines or special characters take care to surround it with "),t("code",[this._v('"')]),this._v(" so that it will be properly escaped.")])])},function(){var e=this.$createElement,t=this._self._c||e;return t("h3",{attrs:{id:"secret-file"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#secret-file","aria-hidden":"true"}},[this._v("#")]),this._v(" Secret file")])},function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("table",[i("thead",[i("tr",[i("th",{staticStyle:{"text-align":"left"}},[e._v("File")]),e._v(" "),i("th",{staticStyle:{"text-align":"left"}},[e._v("Description")])])]),e._v(" "),i("tbody",[i("tr",[i("td",{staticStyle:{"text-align":"left"}},[e._v("keystore file")]),e._v(" "),i("td",{staticStyle:{"text-align":"left"}},[e._v("A binary file containing the private key of the certificate you need to sign the Android app")])]),e._v(" "),i("tr",[i("td",{staticStyle:{"text-align":"left"}},[e._v("cordova build file")]),e._v(" "),i("td",{staticStyle:{"text-align":"left"}},[e._v("A Json file used by Cordova to sign the generated application. It uses the keystore file")])]),e._v(" "),i("tr",[i("td",{staticStyle:{"text-align":"left"}},[e._v("google play service account")]),e._v(" "),i("td",{staticStyle:{"text-align":"left"}},[e._v("A Json file storing the data needed to use the Google Play service account")])]),e._v(" "),i("tr",[i("td",{staticStyle:{"text-align":"left"}},[e._v("google services account")]),e._v(" "),i("td",{staticStyle:{"text-align":"left"}},[e._v("A Json file storing the the keys to access the various Google services")])])])])},function(){var e=this.$createElement,t=this._self._c||e;return t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[this._v("tar cvf secrets.tar your_keystore.keystore build.json google-play.json google-services.json\ntravis encrypt-file secrets.tar\n")])])])},function(){var e=this.$createElement,t=this._self._c||e;return t("h2",{attrs:{id:"configure-application"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#configure-application","aria-hidden":"true"}},[this._v("#")]),this._v(" Configure application")])},function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("ul",[i("li",[e._v("retrieve the "),i("code",[e._v("google-services.json")]),e._v(" to be stored as a secret file in the "),i("em",[e._v("cordova")]),e._v(" directory")]),e._v(" "),i("li",[e._v("create an Android app in your Firebase app and keep track of secret server key in "),i("em",[e._v("Parameters > Cloud Messaging")])])])},function(){var e=this.$createElement,t=this._self._c||e;return t("ul",[t("li",[this._v("keep track of app ARN")])])},function(){var e=this.$createElement,t=this._self._c||e;return t("ul",[t("li",[this._v("Activate the Google+ API on your project")])])},function(){var e=this.$createElement,t=this._self._c||e;return t("ul",[t("li",[this._v("the redirect URL should match "),t("em",[this._v("your.domain/auth/google/callback")])]),this._v(" "),t("li",[this._v("download the "),t("em",[this._v("json")]),this._v(" dans keep track of client ID and secret")])])},function(){var e=this.$createElement,t=this._self._c||e;return t("ul",[t("li",[this._v("the redirect URL should match "),t("em",[this._v("your.domain/auth/github/callback")])]),this._v(" "),t("li",[this._v("download the "),t("em",[this._v("json")]),this._v(" dans keep track of client ID and secret")])])},function(){var e=this.$createElement,t=this._self._c||e;return t("ul",[t("li",[this._v("keep track of access key ID and secret")])])},function(){var e=this.$createElement,t=this._self._c||e;return t("li",[this._v("Create a bucket for your app in the Kalisio account\n"),t("ul",[t("li",[this._v("keep track of its name")])])])},function(){var e=this.$createElement,t=this._self._c||e;return t("ul",[t("li",[this._v("keep track of access key ID and secret")])])},function(){var e=this.$createElement,t=this._self._c||e;return t("div",{staticClass:"tip custom-block"},[t("p",{staticClass:"custom-block-title"},[this._v("TIP")]),this._v(" "),t("p",[this._v("Note: some of the previous accounts/IDs are not app specific and can be share accross multiple apps, e.g. S3, SNS, etc.")])])},function(){var e=this.$createElement,t=this._self._c||e;return t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[this._v("export APP_SECRET=xxx\nexport GOOGLE_MAIL_USER=xxx\nexport GOOGLE_MAIL_PASSWORD=xxx\nexport SNS_ACCESS_KEY=xxx\nexport SNS_SECRET_ACCESS_KEY=xxx\nexport SNS_ANDROID_ARN=xxx\nexport S3_ACCESS_KEY=xxx\nexport S3_SECRET_ACCESS_KEY=xxx\nexport S3_BUCKET=xxx\nexport GITHUB_CLIENT_ID=xxx\nexport GITHUB_CLIENT_SECRET=xxx\nexport GOOGLE_CLIENT_ID=xxx\nexport GOOGLE_CLIENT_SECRET=xxx\n")])])])},function(){var e=this.$createElement,t=this._self._c||e;return t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[this._v("github: {\n  clientID: process.env.GITHUB_CLIENT_ID,\n  clientSecret: process.env.GITHUB_CLIENT_SECRET\n}\n")])])])},function(){var e=this.$createElement,t=this._self._c||e;return t("div",{staticClass:"danger custom-block"},[t("p",{staticClass:"custom-block-title"},[this._v("WARNING")]),this._v(" "),t("p",[this._v("You should never store production passwords or other sensitive production data in a clear form in source code or config files.")])])},function(){var e=this.$createElement,t=this._self._c||e;return t("p",[this._v("During the CI/CD process the script "),t("em",[this._v("travis.env.sh")]),this._v(" automatically generates a temporary environment file, based on the secret environment variables defined in your Travis repository settings or coming from a dedicated private repository (in this case only the access token of this repository needs to be in your Travis settings), to be sourced at the different stages.")])},function(){var e=this.$createElement,t=this._self._c||e;return t("div",{staticClass:"warning custom-block"},[t("p",{staticClass:"custom-block-title"},[this._v("WARNING")]),this._v(" "),t("p",[this._v("You shouldn't use production secrets in development and test mode.")])])},function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("p",[e._v("To avoid publishing by error production secrets we recommand generating an access key/token for each flavor "),i("em",[e._v("AND")]),e._v(" third-party service required by your app using the following naming convention for these tokens: "),i("strong",[e._v("flavor-service")]),e._v(". For instance you would have a "),i("strong",[e._v("dev-s3")]),e._v(", "),i("strong",[e._v("test-s3")]),e._v(" and "),i("strong",[e._v("prod-s3")]),e._v(" keys to use the AWS S3 service respectively in your dev, test and production version of your app.")])}],r=i(0),n=Object(r.a)({},function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("div",{staticClass:"content"},[e._m(0),e._v(" "),e._m(1),e._v(" "),i("p",[e._v("The main purpose of the continuous integration and deployment (CI/CD) pipeline is to create/build application artifacts (Docker images for the web application and mobile application bundles) and deploy it in production-like environments in order to test it. The global CI/CD pipeline is illustrated in the following schema:")]),e._v(" "),e._m(2),e._v(" "),i("p",[e._v("The different operations performed by each stages are the following:")]),e._v(" "),e._m(3),e._v(" "),e._m(4),e._v(" "),e._m(5),e._v(" "),e._m(6),e._v(" "),e._m(7),e._v(" "),i("p",[e._v("Starting from the following base application setup:")]),e._v(" "),e._m(8),e._v(" "),i("p",[e._v("Each flavor is then attached to a different target infrastructure, subdomain and version tag:")]),e._v(" "),e._m(9),e._v(" "),e._m(10),e._v(" "),e._m(11),e._v(" "),e._m(12),e._v(" "),i("p",[e._v("We heavily rely on "),i("a",{attrs:{href:"https://travis-ci.org",target:"_blank",rel:"noopener noreferrer"}},[e._v("Travis CI"),i("OutboundLink")],1),e._v(" for continuous integration and delivery, as such you need to create the CI/CD pipeline in Travis CI by syncing your GitHub repository.")]),e._v(" "),e._m(13),e._v(" "),e._m(14),e._v(" "),i("p",[e._v("If some of the sensitive data are stored using environment variables, you have to use "),i("a",{attrs:{href:"https://docs.travis-ci.com/user/environment-variables/",target:"_blank",rel:"noopener noreferrer"}},[e._v("encrypted environment variables"),i("OutboundLink")],1),e._v(" set either in build file or repository settings.")]),e._v(" "),e._m(15),e._v(" "),e._m(16),e._v(" "),i("p",[e._v("If you need additional sensitive data stored through "),i("a",{attrs:{href:"https://docs.travis-ci.com/user/encrypting-files/",target:"_blank",rel:"noopener noreferrer"}},[e._v("files"),i("OutboundLink")],1),e._v(" create a "),i("em",[e._v("secrets.tar")]),e._v(" containing all secured files and encode it to "),i("em",[e._v("secrets.tar.enc")]),e._v(" a using "),i("router-link",{attrs:{to:"./../../tools/cli.html#travis-cli"}},[e._v("Travis CLI")]),e._v(". This file will be decrypted before the build or whenever you need something inside.")],1),e._v(" "),i("p",[e._v("Indeed, as mentioned in the "),i("a",{attrs:{href:"https://docs.travis-ci.com/user/encrypting-files/#Encrypting-multiple-files",target:"_blank",rel:"noopener noreferrer"}},[e._v("documentation"),i("OutboundLink")],1),e._v(", it is not possible to encrypt multiple files and thus requires to create a "),i("code",[e._v("tar")]),e._v(" file containing the different secret files and encrypts the archive.")]),e._v(" "),i("p",[e._v("The table below lists for example the required files to publish a mobile app using Cordova:")]),e._v(" "),e._m(17),e._v(" "),i("p",[e._v("You need to be logged into Travis CI before generating the secret file like this:")]),e._v(" "),e._m(18),e._m(19),e._v(" "),i("p",[e._v("Depending on the third-party services you need you will have to do the following:")]),e._v(" "),i("ul",[i("li",[e._v("Generate a secret to secure your authentication, use one generated by the Feathers CLI")]),e._v(" "),i("li",[e._v("Create a Firebase app in the "),i("a",{attrs:{href:"https://console.firebase.google.com",target:"_blank",rel:"noopener noreferrer"}},[e._v("Firebase Console"),i("OutboundLink")],1),e._v(" "),e._m(20)]),e._v(" "),i("li",[e._v("Create a GCM application in the "),i("a",{attrs:{href:"https://eu-west-1.console.aws.amazon.com/sns/v2/home",target:"_blank",rel:"noopener noreferrer"}},[e._v("AWS SNS console"),i("OutboundLink")],1),e._v(" using the previous server key\n"),e._m(21)]),e._v(" "),i("li",[e._v("Create a new project for your app in the "),i("a",{attrs:{href:"https://console.cloud.google.com",target:"_blank",rel:"noopener noreferrer"}},[e._v("Google Cloud Console"),i("OutboundLink")],1),e._v(" "),e._m(22)]),e._v(" "),i("li",[e._v("Create an OAuth2 ID for a Web App in "),i("a",{attrs:{href:"https://console.cloud.google.com",target:"_blank",rel:"noopener noreferrer"}},[e._v("Google Cloud Console"),i("OutboundLink")],1),e._v(" > "),i("em",[e._v("API & services")]),e._v(" "),e._m(23)]),e._v(" "),i("li",[e._v("Create an OAuth2 App in "),i("a",{attrs:{href:"https://github.com/organizations/kalisio/settings/applications",target:"_blank",rel:"noopener noreferrer"}},[e._v("GitHub"),i("OutboundLink")],1),e._v(" "),e._m(24)]),e._v(" "),i("li",[e._v("Create an AWS user in "),i("a",{attrs:{href:"https://console.aws.amazon.com/iam/home",target:"_blank",rel:"noopener noreferrer"}},[e._v("IAM"),i("OutboundLink")],1),e._v(" with access to S3 API (e.g. "),i("em",[e._v("AmazonS3FullAccess")]),e._v(")\n"),e._m(25)]),e._v(" "),e._m(26),e._v(" "),i("li",[e._v("Create an AWS user in "),i("a",{attrs:{href:"https://console.aws.amazon.com/iam/home",target:"_blank",rel:"noopener noreferrer"}},[e._v("IAM"),i("OutboundLink")],1),e._v(" with access to SNS API (e.g. "),i("em",[e._v("AmazonSNSFullAccess")]),e._v(")\n"),e._m(27)])]),e._v(" "),e._m(28),e._v(" "),i("p",[e._v("Create required environment variables in a script file you can source before launching your app:")]),e._v(" "),e._m(29),i("p",[e._v("Then, retrieve this variables in config files like this:")]),e._v(" "),e._m(30),i("p",[e._v("In your local development environment you should use the script to setup all the required secrets. This script should be safe-guarded in a non-public environment.")]),e._v(" "),e._m(31),e._v(" "),e._m(32),e._v(" "),e._m(33),e._v(" "),e._m(34)])},s,!1,null,null,null);n.options.__file="deploy.md";t.default=n.exports}}]);